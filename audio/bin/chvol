#!/bin/luajit

function first(iterable)
	for line in iterable do
		return line
	end
end

function firstline(filename)
	file = io.open(filename)
	if file then
		line = first(io.lines(filename))
		io.close(file)
		if line then
			return line
		else
			io.stderr:write("eof: " .. filename .. " is empty")
			os.exit(1)
		end
	else
		io.stderr:write("file_not_found: " .. filename .. " does not exist")
		os.exit(1)
	end
end


if not arg[1] then
	io.stderr:write('no argument given')
	os.exit(1)
end

if string.sub(arg[1], 1, 1) ~= '+' and string.sub(arg[1], 1, 1) ~= '-' then
	io.stderr:write('argument must start with either + or -')
	os.exit(1)
end

if string.sub(arg[1], -1) ~= '%' then
	io.stderr:write('argument must end with %')
	os.exit(1)
end

if not tonumber(arg[1]:sub(1, -2)) then
	io.stderr:write('argument must contain a number')
	os.exit(1)
end

diff = tonumber(arg[1]:sub(1, -2))
print('parsed ' .. diff)

cache = os.getenv("XDG_CACHE_HOME")
newest = tonumber(firstline(cache .. '/bin/pulsetest.newest_sink_index'))
print('newest sink ' .. newest)

currentpath = os.getenv("XDG_CACHE_HOME") .. '/bin/pulsetest.sinks.' .. newest .. '.volume'
print('reading from ' .. currentpath)

current = tonumber(firstline(currentpath))
print('current ' .. current)

new = current + diff
print('new ' .. new)

if new < 0 then
	io.stderr:write('too low')
	os.exit(1)
end

if new > 100 then
	io.stderr:write('too high')
	os.exit(1)
end

if current == new then
	io.stderr:write('no change')
	os.exit(1)
end

os.execute('pactl set-sink-volume ' .. newest .. ' ' .. arg[1])

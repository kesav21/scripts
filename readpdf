#!/bin/sh

#
# prints all pdf files in $HOME
#
lspdf() {
	# i don't really know how this works
	find "$HOME" -type d -path '*/\.*' -prune -o -not -name '.*' -type f -name '*.pdf' -print
}

#
# choose list of pdfs to display, command line and dmenu
# if the first command-line argument is -n, do not use dmenu
#
getpdfs() {
	# always print cmd args
	printf '%s\n' "$@" | sort | uniq | stest -e
	# maybe choose from dmenu
	if [ "$1" != '-n' ]; then
		# choose pdfs, sort and remove duplicates
		# make pdfs presentable for choosing, then convert them back
		lspdf | sed "s|$HOME|~|" | dmenu | sort | uniq | sed "s|~|$HOME|"
	fi
}

#
# if there are no tabbed instances, create new tabbed instance
# if given invalid tabbed instance, create new tabbed instance
# if given valid tabbed instance, use it
#
getxid() {
	# count number of tabbed instances
	tabs="$(xwininfo -children -root | grep 'tabbed' | wc -l)"
	# if no tabbed instances
	if [ "$tabs" -eq 0 ]; then
		# create new instance
		tabbed -cd
	else
		# select tabbed instance using cursor
		# get its xid
		xid=$(xwininfo | awk '/Window id/ {print $4}')
		# if instance is valid tabbed instance
		if [ -n "$(xwininfo -children -root | awk "/$xid.*tabbed/")" ]; then
			# use selected instance
			echo $xid
		else
			# create new instance
			tabbed -cd
		fi
	fi

}

#
# open all given files in tabbed+zathura
#
open() {
	# accepts tabbed xid as input
	echo $1
	# reads pdfs from stdin
	while read -r line; do
		echo $line
		# open in zathura
		zathura -e "$1" "$line" &
	done
}

# put it all together
getpdfs "$@" | open "$(getxid)"

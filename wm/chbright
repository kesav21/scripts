#!/bin/luajit

function readline(filename)
	file = io.open(filename)
	if file then
		for line in io.lines(filename) do
			io.close(file)
			return line
		end
	end
end

function restrict(lower, value, upper)
	if value < lower then
		print('too low ' .. value)
		return lower
	elseif value > upper then
		print('too high ' .. value)
		return upper
	else
		print('just right ' .. value)
		return value
	end
end

diff = tonumber(arg[1]:sub(1, -2))
print('parsed ' .. diff)
current = tonumber(readline('/sys/class/backlight/intel_backlight/brightness'))
print('current ' .. current)
max = tonumber(readline('/sys/class/backlight/intel_backlight/max_brightness'))
print('max ' .. max)
new = restrict(0, current + diff * max / 100, max)
print('new ' .. new)

if current == new then
	print('stale, exiting')
	os.exit(1)
end
print('fresh')

file = io.open('/sys/class/backlight/intel_backlight/brightness', "w")
if not file then
	print('could not open file for writing')
	os.exit(1)
end
print('opened')

io.output(file)
if not io.write(new) then
	print('write failed')
	os.exit(1)
end
print('written')

io.close(file)

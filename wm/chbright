#!/bin/luajit

function readline(filename)
	if io.open(filename) then
		for line in io.lines(filename) do
			return line
		end
		io.close(file)
	end
end

function restrict(lower, value, upper)
	if value < lower then
		print('too low ' .. value)
		return lower
	elseif value > upper then
		print('too high ' .. value)
		return upper
	else
		print('just right ' .. value)
		return value
	end
end

diff = tonumber(arg[1]:sub(1, -2))
print('parsed ' .. diff)
current = tonumber(readline('/sys/class/backlight/intel_backlight/brightness'))
print('current ' .. current)
max = tonumber(readline('/sys/class/backlight/intel_backlight/max_brightness'))
print('max ' .. max)
new = restrict(0, current + diff * max / 100, max)
print('new ' .. new)

if current == new then
	print('stale, exiting')
	os.exit(1)
end

print('writing')
file = io.open('/sys/class/backlight/intel_backlight/brightness', "w")
io.output(file)
io.write(new)
io.close(file)
print('written')
